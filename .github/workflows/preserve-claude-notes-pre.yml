name: claude-was-here Preserve git Notes (Pre-merge)

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  collect-claude-notes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history to access all commits
          
      - name: Fetch git notes
        run: |
          # Fetch default git notes if they exist
          git fetch origin refs/notes/commits:refs/notes/commits 2>/dev/null || echo "No git notes found yet"
          # Show what notes we have
          echo "Checking for existing notes..."
          git log --oneline --notes=commits -n 5 || true
          
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
          
      - name: Get base and head commits
        id: commits
        run: |
          BASE_COMMIT=$(git merge-base HEAD origin/${{ github.base_ref }})
          # Use the actual PR head commit, not the merge commit created by GitHub Actions
          HEAD_COMMIT="${{ github.event.pull_request.head.sha }}"
          echo "base_commit=$BASE_COMMIT" >> $GITHUB_OUTPUT
          echo "head_commit=$HEAD_COMMIT" >> $GITHUB_OUTPUT
          echo "Base commit: $BASE_COMMIT"
          echo "Head commit: $HEAD_COMMIT"
          
      - name: Collect and consolidate Claude notes
        run: |
          bun run .github/scripts/github-synchronize-pr.js --base "${{ steps.commits.outputs.base_commit }}" --head "${{ steps.commits.outputs.head_commit }}"
          
      - name: Upload Claude notes data as artifact
        if: hashFiles('claude-notes-data.json') != ''
        uses: actions/upload-artifact@v4
        with:
          name: claude-notes-pr-${{ github.event.number }}
          path: claude-notes-data.json
          retention-days: 30